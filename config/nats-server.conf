# nunect NATS Server Configuration
# This file is read by scripts/nats-server.sh
# Environment variables from .env are substituted at startup

# =============================================================================
# Network
# =============================================================================
port: ${NATS_PORT}
server_name: ${NATS_SERVER_NAME}

# HTTP monitoring (disabled - use HTTPS below)
# http_port: ${NATS_HTTP_PORT}

# =============================================================================
# Logging
# =============================================================================
debug: ${NATS_DEBUG}
trace: ${NATS_TRACE}

# =============================================================================
# Limits
# =============================================================================
max_connections: 65536
max_payload: 8MB
max_pending: 64MB
write_deadline: 10s

# =============================================================================
# Accounts
# =============================================================================
accounts {
  # System account for monitoring and management
  SYS: {
    users: [
      {user: ${NATS_SYS_USER}, password: ${NATS_SYS_PASSWORD}}
    ]
  }
  
  # Bridge tenant account (voice/data bridging)
  BRIDGE: {
    jetstream: enabled
    users: [
      {
        user: ${NATS_DEFAULT_USER}
        password: ${NATS_DEFAULT_PASSWORD}
        permissions: {
          publish: {
            allow: ["com.bridge.>", "nav.bridge.>", "ops.heartbeat.*", "ops.log.>"]
          }
          subscribe: {
            allow: ["com.bridge.>", "nav.bridge.>", "ops.cmd.>", "ops.status.>"]
          }
        }
      }
    ]
  }
  
  # Engine tenant account (ship systems)
  ENGINE: {
    jetstream: enabled
    users: [
      {
        user: "engine"
        password: "${NATS_DEFAULT_PASSWORD}"
        permissions: {
          publish: {
            allow: ["ops.engine.>", "nav.engine.>", "com.engine.>"]
          }
          subscribe: {
            allow: ["ops.engine.>", "nav.engine.>", "com.engine.>"]
          }
        }
      }
    ]
  }
  
  # Provisioning account (for provisioning workflow)
  PROVISION: {
    users: [
      {
        user: "provisioner"
        password: "${NATS_DEFAULT_PASSWORD}"
        permissions: {
          publish: {
            allow: ["ops.provision.>"]
          }
          subscribe: {
            allow: ["ops.provision.>"]
          }
        }
      }
    ]
  }
}

# Designate SYS as system account for $SYS events
system_account: SYS

# =============================================================================
# JetStream
# =============================================================================
jetstream {
  store_dir: "${NATS_DATA_DIR}"
  max_memory_store: ${NATS_JS_MAX_MEMORY}
  max_file_store: ${NATS_JS_MAX_FILE}
}

# =============================================================================
# HTTPS Monitoring
# =============================================================================
https_port: ${NATS_HTTPS_PORT}
tls {
    cert_file: "${NATS_TLS_CERT}"
    key_file: "${NATS_TLS_KEY}"
}

# =============================================================================
# WebSocket (WSS)
# =============================================================================
websocket {
    port: ${NATS_WS_PORT}
    tls {
        cert_file: "${NATS_TLS_CERT}"
        key_file: "${NATS_TLS_KEY}"
    }
}

# =============================================================================
# Clustering (disabled for single-node dev)
# =============================================================================
# cluster {
#   name: nunect-cluster
#   listen: localhost:4244
#   routes: [
#     nats://localhost:4244
#   ]
# }
